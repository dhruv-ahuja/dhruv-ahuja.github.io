<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://dhruvahuja.me name=base><title>
            
                Writing Rust Bindings for My Python App
            
        </title><meta content="Writing Rust Bindings for My Python App" property=og:title><meta content="Walk through my experience of writing Rust FFI for my Python CLI application" property=og:description><meta content="Walk through my experience of writing Rust FFI for my Python CLI application" name=description><link href=https://dhruvahuja.me/icon/favicon.png rel=icon type=image/png><link href=https://dhruvahuja.me/fonts.css rel=stylesheet><link media="(prefers-color-scheme: dark)" href=/syntax-theme-dark.css rel=stylesheet><link media="(prefers-color-scheme: light)" href=/syntax-theme-light.css rel=stylesheet><script async data-goatcounter=https://dhruv-ahuja.goatcounter.com/count src=https://dhruvahuja.me/js/count.js></script><noscript><img src="https://dhruv-ahuja.goatcounter.com//count?p=/posts/writing-rust-bindings/&t=Writing Rust Bindings for My Python App"></noscript><script defer src=https://dhruvahuja.me/js/codeblock.js></script><script defer src=https://dhruvahuja.me/js/toc.js></script><script src=https://dhruvahuja.me/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="
    Dhruv Ahuja
" href=https://dhruvahuja.me/atom.xml rel=alternate type=application/atom+xml><link href=https://dhruvahuja.me/theme/light.css rel=stylesheet><link href=https://dhruvahuja.me/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://dhruvahuja.me/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://dhruvahuja.me/main.css media=screen rel=stylesheet><link href=https://dhruvahuja.me/custom.css rel=stylesheet><link href=https://dhruvahuja.me/theme-sunset.css rel=stylesheet><script src="https://dhruvahuja.me/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=left-content></div><div class=content><nav><div class=left-nav><a href=https://dhruvahuja.me>Dhruv Ahuja</a><div class=socials><a class=social href=mailto:dhruvahuja2k@gmail.com rel=noopener target=_blank> <img alt=email src=https://dhruvahuja.me/icons/social/email.svg> </a><a class=social href=https://www.linkedin.com/in/dhruvahuja2k/ rel=noopener target=_blank> <img alt=linkedin src=https://dhruvahuja.me/icons/social/linkedin.svg> </a><a class=social href=https://github.com/dhruv-ahuja/ rel=noopener target=_blank> <img alt=github src=https://dhruvahuja.me/icons/social/github.svg> </a></div></div><div class=right-nav><a href=https://dhruvahuja.me/posts style=margin-right:.5em>/posts</a><a href=https://dhruvahuja.me/projects style=margin-right:.5em>/projects</a><a href=https://dhruvahuja.me/oss style=margin-right:.5em>/oss</a><a href=https://dhruvahuja.me/tags style=margin-right:.5em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://dhruvahuja.me/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://dhruvahuja.me/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://dhruvahuja.me/icons/moon.svg> </a><script>updateItemToggleTheme()</script></div></nav><div data-selector="main article p" class=visible-element-observer-root><main><article><div class=title><div class=page-header>Writing Rust Bindings for My Python App</div><div class=meta>Posted on <time>2023-11-06</time><span class=tags-label>::</span><span class=tags> <a class=post-tag href=https://dhruvahuja.me/tags/rust/>rust</a> <a class=post-tag href=https://dhruvahuja.me/tags/python/>python</a> <a class=post-tag href=https://dhruvahuja.me/tags/performance/>performance</a> </span></div></div><section class=body><h2 id=introduction>Introduction</h2><p><a href=https://github.com/dhruv-ahuja/spoti-dl rel=noopener target=_blank title=https://github.com/dhruv-ahuja/spoti-dl>spoti-dl</a>, a Python-based CLI song downloading tool was the first “proper” application that I developed. It acted as a proof-of-concept of my programming skills as a self-taught developer, and helped me land my first job. However, it lacked some basic features, mainly- no parallel downloads for albums and playlists.<p>I recently added a few new features and re-wrote its core functionality in Rust, as I have been enjoying working with Rust’s robust type system, compiler-level error handling and syntax.<h2 id=development>Development</h2><p>Development was relatively smooth for the most part, as the app logic is straightforward — you accept and parse the input Spotify link, the CLI flag parameters and process downloads. I figured out general things by googling and/or through some experimentation, such as the trait implementations to parse CLI flags from <code>String</code>s into <code>enum</code>s and vice-versa. The <code>lazy_static</code> macro helped me allocate a static <code>HashSet</code> containing disallowed characters for files and folder names, on runtime. I also became more comfortable with bound traits and experienced the power of generics. I was able to use the following function across all of my download flows, as it accepts any input <code>P</code> that can be referenced as <code>Path</code> and any input <code>S</code> that can be converted into a <code>String</code> type:<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">add_metadata</span></span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>P, S<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust">    <span class="z-variable z-parameter z-rust">file_path</span><span class="z-punctuation z-separator z-rust">:</span> P,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust">    <span class="z-variable z-parameter z-rust">album_art_path</span><span class="z-punctuation z-separator z-rust">:</span> P,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust">    <span class="z-variable z-parameter z-rust">simple_song</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">spotify<span class="z-punctuation z-accessor z-rust">::</span></span>SimpleSong,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust">    <span class="z-variable z-parameter z-rust">album_name</span><span class="z-punctuation z-separator z-rust">:</span> S,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-keyword z-other z-rust">where</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust">    P<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">AsRef</span><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>Path<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span> + Debug,
</span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust">    S<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Into</span><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-support z-type z-rust">String</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>,
</span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"></span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span><span class="z-keyword z-operator z-range z-rust">...</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>I mainly struggled when implementing the async logic to download songs in parallel, due to my inexperience with writing async code in Rust. I had to spend a lot of time working with the compiler’s restrictions and <a href=https://tokio.rs/ rel=noopener target=_blank title=https://tokio.rs/>Tokio’s</a> <code>’static + Send</code> requirements for spawning tasks, as its work-stealing scheduler model means that a task running in one thread could be picked up by another thread. I used <code>tokio::task::block_in_place</code> to wrap the <code>add_metadata</code> function call as the <a href=https://github.com/Serial-ATA/lofty-rs rel=noopener target=_blank title=https://github.com/Serial-ATA/lofty-rs>lofty</a> crate does not support async.<p>I added a CLI flag, allowing users to specify the number of tasks to use to process parallel downloads, and used batch downloads of 100 songs for playlists, as they can contain several thousands of songs.<p>The following is the core async logic for parallel downloads — calculate songs to be downloaded by each task, make <code>Arc</code>s to pass cheap, shareable clones for certain values, chunk the list of songs and create and wait for the spawned tasks to finish downloads:<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> parallel_tasks<span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">usize</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-keyword z-control z-rust">if</span> album<span class="z-punctuation z-accessor z-dot z-rust">.</span>songs<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">len</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-comparison z-rust">>=</span> cli_args<span class="z-punctuation z-accessor z-dot z-rust">.</span>parallel_downloads <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">usize</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    cli_args<span class="z-punctuation z-accessor z-dot z-rust">.</span>parallel_downloads <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">usize</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span> <span class="z-keyword z-control z-rust">else</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    album<span class="z-punctuation z-accessor z-dot z-rust">.</span>songs<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">len</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> songs_per_task <span class="z-keyword z-operator z-assignment z-rust">=</span> album<span class="z-punctuation z-accessor z-dot z-rust">.</span>songs<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">len</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-arithmetic z-rust">/</span> parallel_tasks<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> remaining_songs <span class="z-keyword z-operator z-assignment z-rust">=</span> album<span class="z-punctuation z-accessor z-dot z-rust">.</span>songs<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">len</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-arithmetic z-rust">%</span> parallel_tasks<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> cli_args <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Arc<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>cli_args</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> album_art_dir <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Arc<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>album_art_dir</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> album_name <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Arc<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>album<span class="z-punctuation z-accessor z-dot z-rust">.</span>name</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> handles <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-type z-rust">Vec</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span>with_capacity<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>parallel_tasks</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> start <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-keyword z-control z-rust">for</span> i <span class="z-keyword z-operator z-rust">in</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-keyword z-operator z-range z-rust">..</span>parallel_tasks <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> end <span class="z-keyword z-operator z-assignment z-rust">=</span> start <span class="z-keyword z-operator z-arithmetic z-rust">+</span> songs_per_task<span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    <span class="z-keyword z-control z-rust">if</span> i <span class="z-keyword z-operator z-comparison z-rust"><</span> remaining_songs <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        end <span class="z-keyword z-operator z-assignment z-rust">+=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">1</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> songs_chunk <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span>album<span class="z-punctuation z-accessor z-dot z-rust">.</span>songs<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span>start<span class="z-keyword z-operator z-range z-rust">..</span>end<span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> handle <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">tokio<span class="z-punctuation z-accessor z-rust">::</span></span>spawn<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-function z-rust">download_songs</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-group z-rust">        file_path<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">clone</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-group z-rust">        cli_args<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">clone</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-group z-rust">        album_art_dir<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">clone</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-group z-rust">        album_name<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">clone</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-group z-rust">        songs_chunk<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">to_vec</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-group z-rust">    </span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    start <span class="z-keyword z-operator z-assignment z-rust">=</span> end<span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    handles<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>handle</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-keyword z-control z-rust">for</span> handle <span class="z-keyword z-operator z-rust">in</span> handles <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    handle<span class="z-punctuation z-accessor z-dot z-rust">.</span>await<span class="z-keyword z-operator z-rust">?</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></code></pre><h2 id=tooling>Tooling</h2><p>I dropped <a href=https://python-poetry.org/ rel=noopener target=_blank title=https://python-poetry.org/>Poetry</a> as it would not be compatible with the Rust bindings and used simple virtual environments for dependency management, and <a href=https://twine.readthedocs.io/en/stable/ rel=noopener target=_blank title=https://twine.readthedocs.io/en/stable/>Twine</a> for distributing built wheels.<p><a href=https://pyo3.rs/v0.20.0/ rel=noopener target=_blank title=https://pyo3.rs/v0.20.0/>Pyo3</a> acts as the bridge between the parent Python code that calls a single exposed Rust function and enables all the inter-op between the two systems. <a href=https://github.com/PyO3/maturin rel=noopener target=_blank title=https://github.com/PyO3/maturin>Maturin</a> compiles the Rust code into a Python library, and also compiles both codebases into a distributable Python wheel.<p>The following is a list of changes I had to make in my <code>Cargo</code> and <code>pyproject</code> TOML files, to ensure that the build process and <code>pip</code> installed package worked as intended:<ul><li><p><code>Maturin</code> did not recognize the project as a mixed Python-Rust project, hence did not include Rust code in the distributable Python wheel. Setting <code>lib.name</code> table’s value to match Python source directory (<code>spotidl</code>) in <code>Cargo.toml</code> fixed this error.</p><li><p><code>pyproject.toml</code> required several modifications — I needed to set the <code>project.scripts</code> value to <code>spoti-dl = "spotidl.main:main"</code>, partially because the project name (<code>spoti-dl</code>) and Python source directory names were different. I also added the <code>python-packages = ["spotidl"]</code> value under <code>tool.maturin</code> to ensure its inclusion during the build process. I also had to add my dependencies and relevant project metadata in their apt sections, after dropping <code>Poetry</code>.</p><li><p><code>Maturin</code> compiles the Rust code as a library inside our Python source directory. It adds an underscore <code>_</code> to the library’s name by default, which is quite confusing. I rectified this by configuring the <code>module-name</code> value under <code>tool.maturin</code>.</p></ul><p>I faced several problems when attempting to build wheels for Linux using Docker, on my M1 MacBook. I must have easily spent 15-20 hours trying to get the <code>openssl-sys</code> crate to compile as it was the single point of failure, using both the python <code>manylinux</code> and <code>maturin</code> Docker images. I tried to integrate a CI/CD setup using GitHub Actions too, but to no avail, as the crate kept failing to compile. You can check the graveyard of my CI’s failed runs <a href=https://github.com/dhruv-ahuja/spoti-dl/actions rel=noopener target=_blank title=https://github.com/dhruv-ahuja/spoti-dl/actions>here</a>. Eventually I had to settle for manually compiling wheels on Linux, Mac and Windows and copying them to a folder before publishing them with <code>Twine</code>.<h2 id=conclusion>Conclusion</h2><p>This was a rewarding experience for me, as I dealt with efficiently processing large amounts of data and sharpened my skills with Rust and <code>Tokio</code>.<p>I witnessed a 20-25% speed increase and 50% less memory consumption in my Rust code when downloading a single song. The development process was smooth as <code>Pyo3</code> and <code>Maturin</code> are very well-documented and provide convenient APIs, make it incredibly easy to get started with writing FFIs for Python.</section></article></main></div></div><div class=right-content><div class=toc><div class=heading>Table of Contents</div><ul class=toc-list><li class=parent><a href=https://dhruvahuja.me/posts/writing-rust-bindings/#introduction>Introduction</a><li class=parent><a href=https://dhruvahuja.me/posts/writing-rust-bindings/#development>Development</a><li class=parent><a href=https://dhruvahuja.me/posts/writing-rust-bindings/#tooling>Tooling</a><li class=parent><a href=https://dhruvahuja.me/posts/writing-rust-bindings/#conclusion>Conclusion</a></ul></div></div>